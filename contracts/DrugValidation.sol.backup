//version with retailers associative array key as addresses

pragma solidity ^0.5.0;

contract DrugValidation {

  address public manufacturer;

  //Model the drug struct
  struct Drug {
    uint id;
    string name;
    string dosage;
    uint batchNumber;
    address manufacturerAddress;
    bool recieved;
  }

  struct CollectionData {
    address collectionAddress;
    uint batchNumber;
    string timestamp;
  }

  // Associative arrays
  mapping (address => string) public retailers;
  mapping (uint => Drug) public drugs;
  mapping (uint => CollectionData) public collectionLog;

  //cache counters
  uint public retailerCount;
  uint public drugCount;
  uint public collectionLogCount;

  constructor() public {
    manufacturer = msg.sender;
  }

  //To add the drug data. Expects 3 arguments
  function addDrug(string memory _name, string memory _dosage, uint _batchNumber) public returns (bool) {
    if (msg.sender == manufacturer) {
      drugCount++; //To increment the drug count by 1 everytime this function is called
      drugs[drugCount] = Drug(drugCount, _name, _dosage, _batchNumber, msg.sender, false); //adding the drug data to the array
      return true;
    } else {
      return false;
    }
  }

  function addRetailer(string memory _name) public {
    retailerCount++;
    retailers[msg.sender] = _name;
  }

  function logCollection(uint _batchNumber, string memory _timestamp) private {
    collectionLogCount++;
    collectionLog[collectionLogCount] = CollectionData(msg.sender, _batchNumber, _timestamp);
  }

  function collectDrug(uint _batchNumber, string memory _timestamp ) public returns (bool) {
    drugs[_batchNumber].recieved = true;
    logCollection(_batchNumber, _timestamp);
    return true;
  }

  function checkDrug(uint _batchNumber) public view returns(uint, string memory, string memory, uint, address) {

    for (uint i = 0; i < drugCount; i++) {
      if( drugs[i].batchNumber == _batchNumber ){
        return(drugs[i].id, drugs[i].name, drugs[i].dosage, drugs[i].batchNumber, drugs[i].manufacturerAddress);
      }
    }
  }

//  function allDrugs() view public returns ()
}
